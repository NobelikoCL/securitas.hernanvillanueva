{% extends 'erp/base.html' %}
{% load static %}

{% block title %}{% if object %}Editar{% else %}Nuevo{% endif %} Personal - ERP CORE{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h3 class="mb-0">
                <i class="fas fa-user-tie me-2"></i>
                {% if object %}Editar{% else %}Nuevo{% endif %} Personal
            </h3>
        </div>
        <div class="card-body">
            <form method="post" id="personalForm" class="needs-validation" novalidate>
                {% csrf_token %}
                
                {% if form.non_field_errors %}
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    {% for error in form.non_field_errors %}
                        {{ error }}
                    {% endfor %}
                </div>
                {% endif %}

                <!-- Sección de Datos Personales -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h5 class="border-bottom pb-2 mb-3">
                            <i class="fas fa-id-card me-2"></i>Datos Personales
                        </h5>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <div class="form-group">
                            <label for="{{ form.nombres.id_for_label }}" class="form-label">
                                {{ form.nombres.label }}
                            </label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-user"></i></span>
                                {{ form.nombres }}
                            </div>
                            {% if form.nombres.errors %}
                                <div class="invalid-feedback d-block">
                                    <i class="fas fa-exclamation-circle me-1"></i>{{ form.nombres.errors.0 }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <div class="form-group">
                            <label for="{{ form.apellidos.id_for_label }}" class="form-label">
                                {{ form.apellidos.label }}
                            </label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-user"></i></span>
                                {{ form.apellidos }}
                            </div>
                            {% if form.apellidos.errors %}
                                <div class="invalid-feedback d-block">
                                    <i class="fas fa-exclamation-circle me-1"></i>{{ form.apellidos.errors.0 }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <div class="form-group">
                            <label for="{{ form.rut.id_for_label }}" class="form-label">
                                {{ form.rut.label }}
                            </label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-id-card"></i></span>
                                {{ form.rut }}
                            </div>
                            {% if form.rut.errors %}
                                <div class="invalid-feedback d-block">
                                    <i class="fas fa-exclamation-circle me-1"></i>{{ form.rut.errors.0 }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <div class="form-group">
                            <label for="{{ form.telefono.id_for_label }}" class="form-label">
                                {{ form.telefono.label }}
                            </label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-phone"></i></span>
                                {{ form.telefono }}
                            </div>
                            {% if form.telefono.errors %}
                                <div class="invalid-feedback d-block">
                                    <i class="fas fa-exclamation-circle me-1"></i>{{ form.telefono.errors.0 }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <div class="form-group">
                            <label for="{{ form.email.id_for_label }}" class="form-label">
                                {{ form.email.label }}
                            </label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                                {{ form.email }}
                            </div>
                            {% if form.email.errors %}
                                <div class="invalid-feedback d-block">
                                    <i class="fas fa-exclamation-circle me-1"></i>{{ form.email.errors.0 }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="col-12 mb-3">
                        <div class="form-group">
                            <label for="{{ form.direccion.id_for_label }}" class="form-label">
                                {{ form.direccion.label }}
                            </label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-map-marker-alt"></i></span>
                                {{ form.direccion }}
                            </div>
                            {% if form.direccion.errors %}
                                <div class="invalid-feedback d-block">
                                    <i class="fas fa-exclamation-circle me-1"></i>{{ form.direccion.errors.0 }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Sección de Datos Laborales -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h5 class="border-bottom pb-2 mb-3">
                            <i class="fas fa-briefcase me-2"></i>Datos Laborales
                        </h5>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <div class="form-group">
                            <label for="{{ form.cliente.id_for_label }}" class="form-label">
                                {{ form.cliente.label }}
                            </label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-building"></i></span>
                                {{ form.cliente }}
                            </div>
                            {% if form.cliente.errors %}
                                <div class="invalid-feedback d-block">
                                    <i class="fas fa-exclamation-circle me-1"></i>{{ form.cliente.errors.0 }}
                                </div>
                            {% endif %}
                            <small class="form-text text-muted">{{ form.cliente.help_text }}</small>
                        </div>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <div class="form-group">
                            <label for="{{ form.instalacion.id_for_label }}" class="form-label">
                                {{ form.instalacion.label }}
                            </label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-map-marked-alt"></i></span>
                                {{ form.instalacion }}
                            </div>
                            {% if form.instalacion.errors %}
                                <div class="invalid-feedback d-block">
                                    <i class="fas fa-exclamation-circle me-1"></i>{{ form.instalacion.errors.0 }}
                                </div>
                            {% endif %}
                            <small class="form-text text-muted">{{ form.instalacion.help_text }}</small>
                        </div>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <div class="form-group">
                            <label for="{{ form.cargo.id_for_label }}" class="form-label">
                                {{ form.cargo.label }}
                            </label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-user-tag"></i></span>
                                {{ form.cargo }}
                            </div>
                            {% if form.cargo.errors %}
                                <div class="invalid-feedback d-block">
                                    <i class="fas fa-exclamation-circle me-1"></i>{{ form.cargo.errors.0 }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <div class="form-group">
                            <label for="{{ form.fecha_contratacion.id_for_label }}" class="form-label">
                                {{ form.fecha_contratacion.label }}
                            </label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="far fa-calendar-alt"></i></span>
                                {{ form.fecha_contratacion }}
                            </div>
                            {% if form.fecha_contratacion.errors %}
                                <div class="invalid-feedback d-block">
                                    <i class="fas fa-exclamation-circle me-1"></i>{{ form.fecha_contratacion.errors.0 }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="col-md-4 mb-3 d-flex align-items-center">
                        <div class="form-check form-switch">
                            {{ form.activo }}
                            <label class="form-check-label ms-2" for="{{ form.activo.id_for_label }}">
                                {{ form.activo.label }}
                            </label>
                            {% if form.activo.errors %}
                                <div class="invalid-feedback d-block">
                                    <i class="fas fa-exclamation-circle me-1"></i>{{ form.activo.errors.0 }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="col-md-4 mb-3 d-flex align-items-center">
                        <div class="form-check form-switch">
                            {{ form.acepta_whatsapp }}
                            <label class="form-check-label ms-2" for="{{ form.acepta_whatsapp.id_for_label }}">
                                {{ form.acepta_whatsapp.label }}
                            </label>
                            {% if form.acepta_whatsapp.errors %}
                                <div class="invalid-feedback d-block">
                                    <i class="fas fa-exclamation-circle me-1"></i>{{ form.acepta_whatsapp.errors.0 }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>



                <div class="row mt-5">
                    <div class="col-12 d-flex justify-content-between">
                        <div>
                            <span class="text-muted small">Los campos marcados con * son obligatorios</span>
                        </div>
                        <div>
                            <a href="{% url 'erp:personal_list' %}" class="btn btn-outline-secondary me-2">
                                <i class="fas fa-times me-1"></i> Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i> {% if object %}Actualizar Personal{% else %}Guardar Personal{% endif %}
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Inicializar tooltips de Bootstrap
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Formatear RUT al perder el foco
    document.getElementById('{{ form.rut.id_for_label }}').addEventListener('blur', function(e) {
        let rut = e.target.value.replace(/[^0-9kK]/g, '');
        if (rut.length > 1) {
            const dv = rut.slice(-1).toUpperCase();
            const rutSinDv = rut.slice(0, -1);
            e.target.value = rutSinDv.replace(/\B(?=(\d{3})+(?!\d))/g, '.') + '-' + dv;
        }
    });

    // Cargar dinámicamente las instalaciones según el cliente seleccionado
    const clienteSelect = document.getElementById('{{ form.cliente.id_for_label }}');
    const instalacionSelect = document.getElementById('{{ form.instalacion.id_for_label }}');

    if (clienteSelect) {
        clienteSelect.addEventListener('change', function() {
            const clienteId = this.value;
            const url = '{% url "erp:ajax_cargar_instalaciones" %}?cliente_id=' + clienteId;
            
            // Mostrar indicador de carga
            instalacionSelect.disabled = true;
            const loadingOption = document.createElement('option');
            loadingOption.text = 'Cargando instalaciones...';
            loadingOption.value = '';
            instalacionSelect.innerHTML = '';
            instalacionSelect.add(loadingOption);
            
            // Realizar la petición AJAX
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    instalacionSelect.innerHTML = '';
                    if (data.instalaciones && data.instalaciones.length > 0) {
                        // Agregar opción por defecto
                        const defaultOption = document.createElement('option');
                        defaultOption.value = '';
                        defaultOption.text = 'Seleccione una instalación';
                        instalacionSelect.add(defaultOption);
                        
                        // Agregar opciones de instalaciones
                        data.instalaciones.forEach(instalacion => {
                            const option = document.createElement('option');
                            option.value = instalacion.id;
                            option.text = instalacion.nombre;
                            instalacionSelect.add(option);
                        });
                    } else {
                        const noOption = document.createElement('option');
                        noOption.value = '';
                        noOption.text = 'No hay instalaciones disponibles';
                        instalacionSelect.add(noOption);
                    }
                    instalacionSelect.disabled = false;
                })
                .catch(error => {
                    console.error('Error al cargar las instalaciones:', error);
                    const errorOption = document.createElement('option');
                    errorOption.value = '';
                    errorOption.text = 'Error al cargar las instalaciones';
                    instalacionSelect.innerHTML = '';
                    instalacionSelect.add(errorOption);
                    instalacionSelect.disabled = false;
                });
        });
        
        // Disparar el evento change si ya hay un valor seleccionado
        if (clienteSelect.value) {
            clienteSelect.dispatchEvent(new Event('change'));
        }
    }

    // Validación del formulario
    (function () {
        'use strict'
        
        // Obtener todos los formularios a los que queremos aplicar estilos de validación de Bootstrap
        var forms = document.querySelectorAll('.needs-validation')
        
        // Bucle sobre ellos y evitar el envío
        Array.prototype.slice.call(forms).forEach(function (form) {
            form.addEventListener('submit', function (event) {
                if (!form.checkValidity()) {
                    event.preventDefault()
                    event.stopPropagation()
                }
                
                form.classList.add('was-validated')
            }, false)
        })
    })()
</script>
{% endblock %}
